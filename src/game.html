<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React</title>
    <script src="https://fb.me/react-0.14.7.js"></script>
    <script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="/state.js"></script>
  </head>
  <body>
    <script>
      var game = {
        player_ids: [3, 7],
        moves: [],
        state: {},
      };
      var game_info = undefined;
      var chat = undefined;
      var socket = undefined;
      var view = undefined;
      window.onload = function() {
        var readCookie = function(name) {
          var c = document.cookie.split('; ');
          for (var i = c.length - 1; i >= 0; i--) {
            var cc = c[i].split('=');
            if (cc[0] === name) {
              return cc[1];
            }
          }
          throw 'Cookie '+name+' not found.';
        };

        socket = new WebSocket('ws://192.168.1.203:8080');
        socket.onerror = function(error) {
          console.log("WebSocket error: " + error);
        };
        socket.onopen = function(e) {
          console.log("WebSocket open");
          socket.send(JSON.stringify({
            type: 'hello',
            session_id: readCookie('session_id'),
            game_id: window.location.href.split('/').pop(),
          }));
        };
        socket.onmessage = function(e) {
          var msg = JSON.parse(e.data);
          if (msg.type === 'chat') {
            chat.add(msg.chat);
          }
          else if (msg.type === 'chats') {
            for (var i = msg.chats.length - 1; i >= 0; i--) {
              chat.add(msg.chats[i]);
            }
          }
          else if (msg.type === 'greetings') {
            game_info = msg;
            view.forceUpdate();
          }
          else if (msg.type === 'yield') {
            view.add_move(msg);
          }
          else if (msg.type === 'moves') {
            view.set_moves(msg.moves);
          }
          else {
            console.log('Unrecognized WebSocket message type: %s', msg.type);
          }
        };
        socket.onclose = function(e) {
          console.log("WebSocket closed");
        };
      };
    </script>
    <div id="chat"></div>
    <script type="text/babel">
      var Chat = React.createClass({
        getInitialState: function() {
          return {chats: []};
        },
        add: function(msg) {
          this.setState({chats: [msg, ...this.state.chats]});
        },
        send: function(e) {
          e.preventDefault();
          socket.send(JSON.stringify({
            type: 'chat',
            text: this.refs.message.value,
          }));
          this.refs.message.value = '';
        },
        render: function() {
          var chats = [];
          for (var i = this.state.chats.length - 1; i >= 0; i--) {
            var chat = this.state.chats[i];
            chats.push(
              <div key={i}>
                [{chat.timestamp}]
                <strong>{chat.username}</strong>:
                {chat.text}
              </div>
            );
          }
          return (
            <form onSubmit={this.send}>
              {chats}
              <input type="text" placeholder="enter a message" ref="message" />
              <input type="submit" value="send" />
            </form>
          );
        },
      });
      chat = ReactDOM.render(<Chat />, document.getElementById('chat'));
    </script>
    <div id="view"></div>
    <script type="text/babel">
      var View = React.createClass({
        getInitialState: function() {
          return {
            player_ids: [3, 7],
            moves: [],
            state: {},
          };
        },
        add_move: function(move) {
          this.setState({
            player_ids: [3, 7],
            moves: [...this.state.moves, move],
            state: {},
          });
        },
        set_moves: function(moves) {
          this.setState({
            player_ids: [3, 7],
            moves: moves,
            state: {},
          });
        },
        yield: function(e) {
          socket.send(JSON.stringify({type: 'yield'}));
        },
        render: function() {
          if (typeof game_info === 'undefined') {
            return (<i>Connecting..</i>);
          }

          var my_turn = state.whose_turn(this.state) == game_info.user_id;
          var draw = state.draw_possible(this.state, game_info.user_id);

          return (
            <div>
              It is <strong>{my_turn ? '' : 'not '}your turn</strong>.
              <input type="button" onClick={this.yield} value="yield"
                disabled={!my_turn} />
              You can draw {draw} cards.
            </div>
          );
        },
      });
      view = ReactDOM.render(<View />, document.getElementById('view'));
    </script>
  </body>
</html>
