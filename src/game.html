<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello React</title>
    <script src="https://fb.me/react-0.14.7.js"></script>
    <script src="https://fb.me/react-dom-0.14.7.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="/state.js"></script>
  </head>
  <body>
    <script>
      var game = {
        player_ids: [3, 7],
        moves: [],
        state: {},
      };
      var game_info = undefined;
      var chat = undefined;
      var turn = undefined;
      var socket = undefined;
      var log = undefined;
      window.onload = function() {
        var readCookie = function(name) {
          var c = document.cookie.split('; ');
          for (var i = c.length - 1; i >= 0; i--) {
            var cc = c[i].split('=');
            if (cc[0] === name) {
              return cc[1];
            }
          }
          throw 'Cookie '+name+' not found.';
        };

        socket = new WebSocket('ws://192.168.1.203:8080');
        socket.onerror = function(error) {
          console.log("WebSocket error: " + error);
        };
        socket.onopen = function(e) {
          console.log("WebSocket open");
          socket.send(JSON.stringify({
            type: 'hello',
            session_id: readCookie('session_id'),
            game_id: window.location.href.split('/').pop(),
          }));
        };
        socket.onmessage = function(e) {
          var msg = JSON.parse(e.data);
          if (msg.type === 'chat') {
            chat.add(msg.chat);
          }
          else if (msg.type === 'chats') {
            for (var i = msg.chats.length - 1; i >= 0; i--) {
              chat.add(msg.chats[i]);
            }
          }
          else if (msg.type === 'greetings') {
            game_info = msg;
          }
          else if (msg.type === 'opponentYield') {
            turn.opponentYield();
          }
          else if (msg.type === 'turns') {
            log.merge(msg.turns);
          }
          else if (msg.type === 'yield') {
            game.moves.push(msg);
            game.state = state.apply_move(game, game.state, msg);
            if (state.whose_turn(game) == game_info.user_id) {
              turn.opponentYield();
            } else {
              turn.yield();
            }
          }
          else {
            console.log('Unrecognized WebSocket message type: %s', msg.type);
          }
        };
        socket.onclose = function(e) {
          console.log("WebSocket closed");
        };
      };
    </script>
    <div id="chat"></div>
    <script type="text/babel">
      var Chat = React.createClass({
        getInitialState: function() {
          return {chats: []};
        },
        add: function(msg) {
          this.setState({chats: [msg, ...this.state.chats]});
        },
        send: function(e) {
          e.preventDefault();
          socket.send(JSON.stringify({
            type: 'chat',
            text: this.refs.message.value,
          }));
          this.refs.message.value = '';
        },
        render: function() {
          var chats = [];
          for (var i = this.state.chats.length - 1; i >= 0; i--) {
            var chat = this.state.chats[i];
            chats.push(
              <div key={i}>
                [{chat.timestamp}]
                <strong>{chat.username}</strong>:
                {chat.text}
              </div>
            );
          }
          return (
            <form onSubmit={this.send}>
              {chats}
              <input type="text" placeholder="enter a message" ref="message" />
              <input type="submit" value="send" />
            </form>
          );
        },
      });
      chat = ReactDOM.render(<Chat />, document.getElementById('chat'));
    </script>
    <div id="turn"></div>
    <script type="text/babel">
      var Turn = React.createClass({
        getInitialState: function() {
          return {yours: false};
        },
        opponentYield: function() {
          this.setState({yours: true});
        },
        yield: function(e) {
          socket.send(JSON.stringify({
            type: 'yield',
            user_id: game_info.user_id
          }));
          this.setState({yours: false});
        },
        render: function() {
          return (
            <form>
              It is <strong>{this.state.yours ? '' : 'not '}your turn</strong>.
              <input type="button" onClick={this.yield} value="yield"
                disabled={!this.state.yours} />
            </form>
          );
        },
      });
      turn = ReactDOM.render(<Turn />, document.getElementById('turn'));
    </script>
    <div id="log"></div>
    <script type="text/babel">
var Log = React.createClass({
  getInitialState: function() {
    return {turns: []};
  },
  merge: function(added) {
    this.setState({turns: added});
  },
  render: function() {
    var turns = [];
    for (var t = 0; t < this.state.turns.length; t++) {
      var turn = this.state.turns[t];
      var player = turn.user_id == game_info.user_id ? 'you' : 'they';
      var moves = [];
      for (var m = 0; m < turn.moves.length; m++) {
        var move = turn.moves[m];
        var desc = (<span>unknown move type</span>);
        if (move.type === 'draw') {
          desc = (<span>{player} drew {move.count} cards</span>);
        }
        moves.push(
          <div key={m}>
            <strong>{move.type}</strong> - <i>{desc}</i>
          </div>
        );
      }
      turns.push(
        <div key={t}>
          A turn by user {turn.user_id}
          {moves}
        </div>
      );
    }
    return (
      <div>{turns}</div>
    );
  },
});
log = ReactDOM.render(<Log />, document.getElementById('log'));
    </script>
  </body>
</html>
